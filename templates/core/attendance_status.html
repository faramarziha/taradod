{% extends "core/base_management.html" %}
{% load jformat %}
{% block extra_css %}
{{ block.super }}
<style>
  .page-md { max-width: 785px; }
</style>
{% endblock %}
{% block title %}وضعیت حضور و غیاب{% endblock %}
{% block management_content %}
<div class="card page page-md fade-in">
<h2 class="page-title">
  <i class="fas fa-user-check"></i> وضعیت حضور و غیاب
</h2>
<form method="get" style="margin-bottom:1rem;text-align:right;">
  {{ form.date.label_tag }}
  {{ form.date }}
  <button type="submit" class="btn">نمایش</button>
</form>
<div style="margin-bottom:1rem;text-align:right;">
  تاریخ: {{ jdate }}
</div>
<div class="status-grid">
  <div class="status-card">
    <div class="status-card-header">
      <h4>حاضرین</h4>
      <span class="status-badge" id="present-count">{{ present_users|length }}</span>
    </div>
    <div class="user-grid" id="present-list">
      {% for u in present_users %}
        <div class="user-card"><span class="user-name">{{ u.get_full_name }}</span><span class="user-code">{{ u.personnel_code }}</span></div>
      {% empty %}
        <div class="empty">موردی نیست</div>
      {% endfor %}
    </div>
  </div>
  <div class="status-card">
    <div class="status-card-header">
      <h4>غایبین</h4>
      <span class="status-badge" id="absent-count">{{ absent_users|length }}</span>
    </div>
    <div class="user-grid" id="absent-list">
      {% for u in absent_users %}
        <div class="user-card"><span class="user-name">{{ u.get_full_name }}</span><span class="user-code">{{ u.personnel_code }}</span></div>
      {% empty %}
        <div class="empty">موردی نیست</div>
      {% endfor %}
    </div>
  </div>
  <div class="status-card">
    <div class="status-card-header">
      <h4>مرخصی</h4>
      <span class="status-badge" id="leave-count">{{ leave_users|length }}</span>
    </div>
    <div class="user-grid" id="leave-list">
      {% for u in leave_users %}
        <div class="user-card"><span class="user-name">{{ u.get_full_name }}</span><span class="user-code">{{ u.personnel_code }}</span></div>
      {% empty %}
        <div class="empty">موردی نیست</div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
{% if realtime %}
<script>
// به‌روزرسانی وضعیت حضور هر ۳۰ ثانیه
function refreshStatus(){
  const dateVal = document.getElementById('id_date').value;
  fetch("{% url 'api_attendance_status' %}?date=" + encodeURIComponent(dateVal))
    .then(r => r.json())
    .then(data => {
      const present = document.getElementById('present-list');
      present.innerHTML = data.present.map(u => `<div class=\"user-card\"><span class=\"user-name\">${u.name}</span><span class=\"user-code\">${u.code}</span></div>`).join('') || '<div class="empty">موردی نیست</div>';
      document.getElementById('present-count').textContent = data.present.length;
      const absent = document.getElementById('absent-list');
      absent.innerHTML = data.absent.map(u => `<div class=\"user-card\"><span class=\"user-name\">${u.name}</span><span class=\"user-code\">${u.code}</span></div>`).join('') || '<div class="empty">موردی نیست</div>';
      document.getElementById('absent-count').textContent = data.absent.length;
      const leave = document.getElementById('leave-list');
      leave.innerHTML = data.leave.map(u => `<div class=\"user-card\"><span class=\"user-name\">${u.name}</span><span class=\"user-code\">${u.code}</span></div>`).join('') || '<div class="empty">موردی نیست</div>';
      document.getElementById('leave-count').textContent = data.leave.length;
    });
}
setInterval(refreshStatus, 30000);
</script>
{% endif %}
{% endblock %}
