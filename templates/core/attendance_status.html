{% extends "core/base_management.html" %}
{% load jformat %}
{% block title %}وضعیت حضور و غیاب{% endblock %}
{% block management_content %}
<div class="card page page-md fade-in">
<h2 class="page-title">
  <i class="fas fa-user-check"></i> وضعیت حضور و غیاب
</h2>
<form method="get" style="margin-bottom:1rem;text-align:right;">
  {{ form.date.label_tag }}
  {{ form.date }}
  <button type="submit" class="btn">نمایش</button>
</form>
<div style="margin-bottom:1rem;text-align:right;">
  تاریخ: {{ jdate }}
</div>
<div class="status-grid">
  <div class="attendance-box">
    <div class="box-header">
      <span class="box-title">حاضرین</span>
      <span class="badge" id="present-count">{{ present_users|length }}</span>
    </div>
    <div class="box-list" id="present-list">
      {% for u in present_users %}
        <div class="person-card">
          <span class="person-name">{{ u.get_full_name }}</span>
          <span class="person-code">{{ u.personnel_code }}</span>
        </div>
      {% empty %}
        <div class="empty">موردی نیست</div>
      {% endfor %}
    </div>
  </div>
  <div class="attendance-box">
    <div class="box-header">
      <span class="box-title">غایبین</span>
      <span class="badge" id="absent-count">{{ absent_users|length }}</span>
    </div>
    <div class="box-list" id="absent-list">
      {% for u in absent_users %}
        <div class="person-card">
          <span class="person-name">{{ u.get_full_name }}</span>
          <span class="person-code">{{ u.personnel_code }}</span>
        </div>
      {% empty %}
        <div class="empty">موردی نیست</div>
      {% endfor %}
    </div>
  </div>
  <div class="attendance-box">
    <div class="box-header">
      <span class="box-title">مرخصی</span>
      <span class="badge" id="leave-count">{{ leave_users|length }}</span>
    </div>
    <div class="box-list" id="leave-list">
      {% for u in leave_users %}
        <div class="person-card">
          <span class="person-name">{{ u.get_full_name }}</span>
          <span class="person-code">{{ u.personnel_code }}</span>
        </div>
      {% empty %}
        <div class="empty">موردی نیست</div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function updateInitialCounts(){
  ['present','absent','leave'].forEach(type => {
    const list = document.getElementById(type+'-list');
    const badge = document.getElementById(type+'-count');
    badge.textContent = list.querySelectorAll('.person-card').length;
  });
}
updateInitialCounts();
{% if realtime %}
function refreshStatus(){
  const dateVal = document.getElementById('id_date').value;
  fetch("{% url 'api_attendance_status' %}?date=" + encodeURIComponent(dateVal))
    .then(r => r.json())
    .then(data => {
      const render = (items, listId, countId) => {
        const list = document.getElementById(listId);
        const count = document.getElementById(countId);
        if(items.length){
          list.innerHTML = items.map(u => `\
            <div class="person-card">\
              <span class="person-name">${u.name}</span>\
              <span class="person-code">${u.code}</span>\
            </div>`).join('');
        }else{
          list.innerHTML = '<div class="empty">موردی نیست</div>';
        }
        count.textContent = items.length;
      };
      render(data.present, 'present-list', 'present-count');
      render(data.absent, 'absent-list', 'absent-count');
      render(data.leave, 'leave-list', 'leave-count');
    });
}
setInterval(refreshStatus, 30000);
{% endif %}
</script>
{% endblock %}
