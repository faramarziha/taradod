{% extends "core/base_management.html" %}
{% block title %}مدیریت کاربران{% endblock %}
{% block management_content %}
<h2 class="page-title">
  <i class="fas fa-users-cog"></i>
  مدیریت کاربران
</h2>
<a class="btn" href="{% url 'user_add' %}" style="margin-bottom:1.4rem;">
  <i class="fas fa-user-plus" style="margin-left:0.5rem;"></i> افزودن کاربر جدید
</a>

<form method="get" class="filter-panel" style="margin-bottom:1rem;">
  <input type="text" name="q" placeholder="جستجو..." value="{{ request.GET.q }}">
  <select name="status">
    <option value="">همه وضعیت‌ها</option>
    <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>فعال</option>
    <option value="inactive" {% if request.GET.status == 'inactive' %}selected{% endif %}>غیرفعال</option>
  </select>
  <select name="group">
    <option value="">گروه</option>
    {% for g in groups %}
      <option value="{{ g.id }}" {% if request.GET.group == g.id|stringformat:'s' %}selected{% endif %}>{{ g.name }}</option>
    {% endfor %}
  </select>
  <select name="shift">
    <option value="">شیفت</option>
    {% for s in shifts %}
      <option value="{{ s.id }}" {% if request.GET.shift == s.id|stringformat:'s' %}selected{% endif %}>{{ s.name }}</option>
    {% endfor %}
  </select>
  <select name="face">
    <option value="">ثبت چهره</option>
    <option value="with" {% if request.GET.face == 'with' %}selected{% endif %}>ثبت شده</option>
    <option value="without" {% if request.GET.face == 'without' %}selected{% endif %}>ثبت نشده</option>
  </select>
  <button class="btn" type="submit">فیلتر</button>
</form>

<form method="post" id="bulk-form">
  {% csrf_token %}
  <div class="bulk-actions" style="margin-bottom:0.5rem;">
    <select name="bulk_action" id="bulk-action-select">
      <option value="">عملیات گروهی</option>
      <option value="deactivate">غیرفعال کردن</option>
      <option value="assign_group">تخصیص به گروه</option>
      <option value="assign_shift">تخصیص شیفت</option>
      <option value="delete">حذف</option>
    </select>
    <select name="group" id="bulk-group-select">
      <option value="">انتخاب گروه</option>
      {% for g in groups %}
        <option value="{{ g.id }}">{{ g.name }}</option>
      {% endfor %}
    </select>
    <select name="shift" id="bulk-shift-select">
      <option value="">انتخاب شیفت</option>
      {% for s in shifts %}
        <option value="{{ s.id }}">{{ s.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn">اعمال</button>
  </div>

  <div class="table-responsive">
    <table class="management-table">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <th>ردیف</th>
          <th>کد پرسنلی</th>
          <th>نام و نام خانوادگی</th>
          <th>وضعیت</th>
          <th>ثبت چهره</th>
          <th>عملیات</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
          <tr>
            <td><input type="checkbox" name="selected_users" value="{{ user.id }}"></td>
            <td>{{ forloop.counter }}</td>
            <td>{{ user.personnel_code }}</td>
            <td>{{ user.get_full_name }}</td>
            <td>
              {% if user.is_active %}
                <span class="alert-success" style="padding:0.15rem 0.4rem;font-size:0.95em;">فعال</span>
              {% else %}
                <span class="alert-error" style="padding:0.15rem 0.4rem;font-size:0.95em;">غیرفعال</span>
              {% endif %}
            </td>
            <td>
              {% if user.face_encoding %}
                <i class="fa fa-check-circle" style="color: var(--color-secondary);"></i>
              {% else %}
                <i class="fa fa-times-circle" style="color: var(--color-error);"></i>
              {% endif %}
            </td>
            <td>
              <a href="{% url 'admin_user_profile' user.pk %}" title="پروفایل"><i class="fas fa-user"></i></a>
              <a href="#" class="delete-user" data-url="{% url 'user_delete' user.pk %}" title="حذف"><i class="fas fa-trash-alt"></i></a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7">هیچ کاربری یافت نشد</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</form>

<div id="delete-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <p>آیا از حذف کاربر مطمئن هستید؟</p>
    <form method="post" id="delete-form">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">حذف</button>
      <button type="button" class="btn" id="cancel-delete">انصراف</button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const selectAll = document.getElementById('select-all');
if(selectAll){
  selectAll.addEventListener('change', function(){
    document.querySelectorAll('input[name="selected_users"]').forEach(cb => cb.checked = selectAll.checked);
  });
}

// bulk delete confirmation
const bulkForm = document.getElementById('bulk-form');
if(bulkForm){
  bulkForm.addEventListener('submit', function(e){
    if(document.getElementById('bulk-action-select').value === 'delete'){
      if(!confirm('آیا از حذف کاربران انتخاب شده مطمئن هستید؟')){
        e.preventDefault();
      }
    }
  });
}

// single delete modal
const modal = document.getElementById('delete-modal');
const deleteForm = document.getElementById('delete-form');
document.querySelectorAll('.delete-user').forEach(btn => {
  btn.addEventListener('click', function(ev){
    ev.preventDefault();
    deleteForm.action = this.dataset.url;
    modal.style.display = 'block';
  });
});
document.getElementById('cancel-delete').addEventListener('click', function(){
  modal.style.display = 'none';
});

// toggle group/shift selects based on action
const actionSelect = document.getElementById('bulk-action-select');
const groupSelect = document.getElementById('bulk-group-select');
const shiftSelect = document.getElementById('bulk-shift-select');
function toggleAux(){
  groupSelect.style.display = actionSelect.value === 'assign_group' ? 'inline-block' : 'none';
  shiftSelect.style.display = actionSelect.value === 'assign_shift' ? 'inline-block' : 'none';
}
toggleAux();
if(actionSelect){ actionSelect.addEventListener('change', toggleAux); }
</script>
{% endblock %}
