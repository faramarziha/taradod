{% extends "core/base_management.html" %}
{% load jformat %}
{% block title %}پروفایل {{ user_obj.get_full_name }}{% endblock %}
{% block management_content %}
<h2 class="page-title"><i class="fas fa-user-cog"></i> پروفایل {{ user_obj.get_full_name }}</h2>
<ul class="tabs">
  <li><a href="#info" class="tab-link active">اطلاعات پایه</a></li>
  <li><a href="#logs" class="tab-link">گزارش تردد</a></li>
  <li><a href="#requests" class="tab-link">سوابق درخواست‌ها</a></li>
  <li><a href="#face" class="tab-link">مدیریت چهره</a></li>
</ul>
<div id="info" class="tab-content active">
  {% include "core/_user_form_fields.html" with cancel_url=request.path %}
</div>
<div id="logs" class="tab-content">
  <div class="profile-actions" style="margin-bottom:1rem;">
    <a class="btn" href="?month={{ prev_month }}#logs"><i class="fas fa-chevron-right"></i> ماه قبل</a>
    <span style="margin:0 1rem;">{{ log_jyear }}/{{ log_jmonth }}</span>
    <a class="btn" href="?month={{ next_month }}#logs">ماه بعد <i class="fas fa-chevron-left"></i></a>
  </div>
  <div class="log-cards mobile-only">
    {% for day, info in daily_logs.items %}
    <div class="log-card fade-in">
      <span>{{ log_jyear }}/{{ log_jmonth|stringformat:"02d" }}/{{ day|stringformat:"02d" }}</span>
      <span>{% if info.in %}{{ info.in|time:"H:i" }}{% else %}-{% endif %}</span>
      <span>{% if info.out %}{{ info.out|time:"H:i" }}{% else %}-{% endif %}</span>
    </div>
    {% endfor %}
  </div>
  <div class="table-responsive desktop-only">
    <table class="management-table">
      <thead><tr><th>تاریخ</th><th>ورود</th><th>خروج</th></tr></thead>
      <tbody>
        {% for day, info in daily_logs.items %}
        <tr>
          <td>{{ log_jyear }}/{{ log_jmonth|stringformat:"02d" }}/{{ day|stringformat:"02d" }}</td>
          <td>{% if info.in %}{{ info.in|time:"H:i" }}{% else %}-{% endif %}</td>
          <td>{% if info.out %}{{ info.out|time:"H:i" }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<div id="requests" class="tab-content">
  <form method="get" class="form-inline" style="margin-bottom:1rem;">
    {{ requests_form.start.label }} {{ requests_form.start }}
    {{ requests_form.end.label }} {{ requests_form.end }}
    <button class="btn" type="submit">نمایش</button>
  </form>
  <h3>درخواست‌های ویرایش</h3>
  <div class="table-responsive">
    <table class="management-table">
      <thead><tr><th>زمان</th><th>نوع</th><th>وضعیت</th></tr></thead>
      <tbody>
        {% for r in edit_requests %}
        <tr>
          <td>{{ r.timestamp|jformat:"%Y/%m/%d %H:%M" }}</td>
          <td>{% if r.log_type == 'in' %}ورود{% else %}خروج{% endif %}</td>
          <td>{{ r.get_status_display }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3">درخواستی وجود ندارد</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <h3 style="margin-top:1rem;">درخواست‌های مرخصی</h3>
  <div class="table-responsive">
    <table class="management-table">
      <thead><tr><th>بازه</th><th>نوع</th><th>وضعیت</th></tr></thead>
      <tbody>
        {% for r in leave_requests %}
        <tr>
          <td>{{ r.start_date|jformat:"%Y/%m/%d" }} - {{ r.end_date|jformat:"%Y/%m/%d" }}</td>
          <td>{% if r.leave_type %}{{ r.leave_type.name }}{% else %}-{% endif %}</td>
          <td>{{ r.get_status_display }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3">درخواستی وجود ندارد</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<div id="face" class="tab-content">
  {% if user_obj.face_image %}
    <img src="{{ user_obj.face_image.url }}" alt="face" style="max-width:200px;width:100%;height:auto;display:block;margin-bottom:1rem;">
    <form method="post" action="{% url 'user_face_delete' user_obj.pk %}" style="margin-bottom:1rem;">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">حذف چهره</button>
    </form>
  {% else %}
    <p>چهره‌ای ثبت نشده است.</p>
  {% endif %}
  <a class="btn" href="{% url 'register_face_page_for_user' user_obj.pk %}">ثبت/به‌روزرسانی چهره</a>
</div>
{% endblock %}

  {% block extra_js %}
<script>
function activateTab(selector){
  document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const link = document.querySelector(`.tab-link[href='${selector}']`);
  const target = document.querySelector(selector);
  if(link && target){
    link.classList.add('active');
    target.classList.add('active');
  }
}

document.querySelectorAll('.tab-link').forEach(link => {
  link.addEventListener('click', function(e){
    e.preventDefault();
    activateTab(this.getAttribute('href'));
  });
});

if(location.hash){
  activateTab(location.hash);
}
</script>
{% endblock %}
