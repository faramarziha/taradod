{% extends "core/base.html" %}
{% load static jformat %}
{% block title %}پروفایل کارمند{% endblock %}
{% block content %}
<div class="card page page-md profile-card fade-in">
  <div class="profile-banner">
    <div class="today-status-card status-{{ today_status.status }}">
      <h3>حضور امروز</h3>
      <p>
        {% if today_status.status == 'present' %}
          حاضر از {% if today_status.first_in %}{{ today_status.first_in|time:"H:i" }}{% else %}-{% endif %}
        {% elif today_status.status == 'absent' %}
          غایب
        {% elif today_status.status == 'leave' %}
          مرخصی
        {% else %}
          روز تعطیل
        {% endif %}
      </p>
    </div>
    <img class="profile-avatar" src="{% if user.face_image %}{{ user.face_image.url }}{% else %}{% static 'core/avatar.png' %}{% endif %}" alt="{{ user.get_full_name }}">
    <h2 class="page-title">
      <i class="fa fa-user"></i>
      {{ user.get_full_name }}
    </h2>
    <p class="profile-meta">کد پرسنلی: {{ user.personnel_code }} | کد ملی: {{ user.national_id }}</p>
  </div>

  <ul class="tabs">
    <li><a href="#logs" class="tab-link active">مشاهده تردد</a></li>
    <li><a href="#edit-requests" class="tab-link">اصلاح تردد</a></li>
    <li><a href="#leave-requests" class="tab-link">مرخصی‌ها</a></li>
    <li><a href="#monthly-performance" class="tab-link">عملکرد ماهانه</a></li>
  </ul>

  <div id="logs" class="tab-content active">
    <div class="profile-actions" style="margin-bottom:1rem;">
      <a class="btn" href="?month={{ prev_month }}#logs"><i class="fas fa-chevron-right"></i> ماه قبل</a>
      <span style="margin:0 1rem;">{{ log_jyear }}/{{ log_jmonth }}</span>
      <a class="btn" href="?month={{ next_month }}#logs">ماه بعد <i class="fas fa-chevron-left"></i></a>
    </div>
    <div class="log-cards mobile-only">
      {% for day, info in daily_logs.items %}
      <div class="log-card fade-in">
        <span>{{ log_jyear }}/{{ log_jmonth|stringformat:"02d" }}/{{ day|stringformat:"02d" }}</span>
        <span>{% if info.in %}{{ info.in|time:"H:i" }}{% else %}-{% endif %}</span>
        <span>{% if info.out %}{{ info.out|time:"H:i" }}{% else %}-{% endif %}</span>
      </div>
      {% endfor %}
    </div>
    <div class="table-responsive desktop-only">
      <table class="management-table">
        <thead>
          <tr><th>تاریخ</th><th>ورود</th><th>خروج</th></tr>
        </thead>
        <tbody>
          {% for day, info in daily_logs.items %}
          <tr>
            <td>{{ log_jyear }}/{{ log_jmonth|stringformat:"02d" }}/{{ day|stringformat:"02d" }}</td>
            <td>{% if info.in %}{{ info.in|time:"H:i" }}{% else %}-{% endif %}</td>
            <td>{% if info.out %}{{ info.out|time:"H:i" }}{% else %}-{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="edit-requests" class="tab-content">
    {% if edit_requests %}
    <div class="request-cards mobile-only">
      {% for r in edit_requests %}
      <div class="request-card fade-in">
        <div class="row"><span class="label">زمان:</span><span>{{ r.timestamp|jformat:"%Y/%m/%d %H:%M" }}</span></div>
        <div class="row"><span class="label">نوع:</span><span>{% if r.log_type == 'in' %}ورود{% else %}خروج{% endif %}</span></div>
        <div class="row"><span class="label">توضیح:</span><span>{{ r.note|default:"-" }}</span></div>
        <div class="row"><span class="label">وضعیت:</span>
          <span class="badge {% if r.status == 'approved' %}badge-success{% elif r.status == 'rejected' %}badge-error{% elif r.status == 'cancelled' %}badge-warning{% else %}badge-info{% endif %}">
            {% if r.status == 'pending' %}در انتظار{% elif r.status == 'approved' %}تأیید شده{% elif r.status == 'cancelled' %}لغو شده{% else %}رد شده{% endif %}
          </span>
        </div>
        <div class="row"><span class="label">توضیح مدیر:</span><span>{{ r.manager_note|default:"-" }}</span></div>
        <div class="actions">
          {% if r.status == 'pending' %}
          <form method="post" action="{% url 'cancel_edit_request' r.id %}" style="display:flex;gap:0.4rem;">
            {% csrf_token %}
            <button class="btn btn-danger" style="font-size:0.8rem;">لغو</button>
          </form>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="table-responsive desktop-only">
      <table class="management-table">
        <thead>
          <tr>
            <th>زمان</th>
            <th>نوع</th>
            <th>توضیح</th>
            <th>وضعیت</th>
            <th>توضیح مدیر</th>
            <th>لغو</th>
          </tr>
        </thead>
        <tbody>
        {% for r in edit_requests %}
          <tr>
            <td>{{ r.timestamp|jformat:"%Y/%m/%d %H:%M" }}</td>
            <td>{% if r.log_type == 'in' %}ورود{% else %}خروج{% endif %}</td>
            <td>{{ r.note|default:"-" }}</td>
            <td>
              <span class="badge {% if r.status == 'approved' %}badge-success{% elif r.status == 'rejected' %}badge-error{% elif r.status == 'cancelled' %}badge-warning{% else %}badge-info{% endif %}">
                {% if r.status == 'pending' %}در انتظار{% elif r.status == 'approved' %}تأیید شده{% elif r.status == 'cancelled' %}لغو شده{% else %}رد شده{% endif %}
              </span>
            </td>
            <td>{{ r.manager_note|default:"-" }}</td>
            <td>
              {% if r.status == 'pending' %}
              <form method="post" action="{% url 'cancel_edit_request' r.id %}">
                {% csrf_token %}
                <button class="btn btn-danger" style="font-size:0.8rem;">لغو</button>
              </form>
              {% else %}-{% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert-error" style="text-align:right;margin:2rem 0;">درخواستی ثبت نشده است.</div>
    {% endif %}
    <div class="profile-actions" style="margin-top:1rem;">
      <a class="btn" href="{% url 'edit_request' %}" style="margin-left:0.5rem;"><i class="fa fa-edit" style="margin-left:0.4rem;"></i> درخواست جدید</a>
    </div>
  </div>

  <div id="leave-requests" class="tab-content">
    {% if leave_requests %}
    <div class="request-cards mobile-only">
      {% for r in leave_requests %}
      <div class="request-card fade-in">
        <div class="row"><span class="label">از:</span><span>{{ r.start_date|jformat:"%Y/%m/%d" }}</span></div>
        <div class="row"><span class="label">تا:</span><span>{{ r.end_date|jformat:"%Y/%m/%d" }}</span></div>
        {% if r.leave_type %}<div class="row"><span class="label">نوع:</span><span>{{ r.leave_type }}</span></div>{% endif %}
        <div class="row"><span class="label">توضیح:</span><span>{{ r.reason|default:"-" }}</span></div>
        <div class="row"><span class="label">وضعیت:</span><span>{% if r.status == 'pending' %}در انتظار{% elif r.status == 'approved' %}تأیید شده{% elif r.status == 'cancelled' %}لغو شده{% else %}رد شده{% endif %}</span></div>
        <div class="row"><span class="label">توضیح مدیر:</span><span>{{ r.manager_note|default:"-" }}</span></div>
        <div class="actions">
          {% if r.status == 'pending' %}
          <form method="post" action="{% url 'cancel_leave_request' r.id %}" style="display:flex;gap:0.4rem;">
            {% csrf_token %}
            <button class="btn btn-danger" style="font-size:0.8rem;">لغو</button>
          </form>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="table-responsive desktop-only">
      <table class="management-table">
        <thead>
          <tr>
            <th>از</th>
            <th>تا</th>
            <th>نوع</th>
            <th>توضیح</th>
            <th>وضعیت</th>
            <th>توضیح مدیر</th>
            <th>لغو</th>
          </tr>
        </thead>
        <tbody>
        {% for r in leave_requests %}
          <tr>
            <td>{{ r.start_date|jformat:"%Y/%m/%d" }}</td>
            <td>{{ r.end_date|jformat:"%Y/%m/%d" }}</td>
            <td>{{ r.leave_type|default:"-" }}</td>
            <td>{{ r.reason|default:"-" }}</td>
            <td>{% if r.status == 'pending' %}در انتظار{% elif r.status == 'approved' %}تأیید شده{% elif r.status == 'cancelled' %}لغو شده{% else %}رد شده{% endif %}</td>
            <td>{{ r.manager_note|default:"-" }}</td>
            <td>
              {% if r.status == 'pending' %}
              <form method="post" action="{% url 'cancel_leave_request' r.id %}">
                {% csrf_token %}
                <button class="btn btn-danger" style="font-size:0.8rem;">لغو</button>
              </form>
              {% else %}-{% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert-error" style="text-align:right;margin:2rem 0;">درخواستی ثبت نشده است.</div>
    {% endif %}
    <div class="profile-actions">
      <a class="btn" href="{% url 'leave_request' %}" style="margin-left:0.5rem;"><i class="fa fa-calendar-plus" style="margin-left:0.4rem;"></i> درخواست جدید</a>
    </div>
  </div>

  <div id="monthly-performance" class="tab-content">
    <form method="get" action="#monthly-performance" class="card report-filter" style="margin-top:1rem;">
      <div class="form-grid">
        <div>{{ mp_form.year.label_tag }}{{ mp_form.year }}</div>
        <div>{{ mp_form.month.label_tag }}{{ mp_form.month }}</div>
      </div>
      <button type="submit" class="btn">نمایش</button>
    </form>
    <div class="dashboard-stats" style="margin-top:1rem;">
      <div class="dashboard-card"><div class="value">{{ monthly_report.required_hours }}</div><div class="label">ساعات موظفی</div></div>
      <div class="dashboard-card"><div class="value">{{ monthly_report.present_hours }}</div><div class="label">ساعات حضور</div></div>
      <div class="dashboard-card"><div class="value">{{ monthly_report.overtime_minutes }}</div><div class="label">اضافه/کسری (دقیقه)</div></div>
      <div class="dashboard-card"><div class="value">{{ monthly_report.absence_days }}</div><div class="label">روز غیبت</div></div>
      <div class="dashboard-card"><div class="value">{{ monthly_report.tardy_minutes }}</div><div class="label">دقایق تأخیر</div></div>
    </div>
    {% if monthly_report.incomplete_days %}
    <div class="card" style="margin-top:1rem;">
      <h4>تردد ناقص</h4>
      <ul>
        {% for d in monthly_report.incomplete_days %}
          <li>{{ d|jformat:"%Y/%m/%d" }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>

  <div class="profile-actions" style="margin-top:1rem;">
    <a class="btn" href="{% url 'user_inquiry' %}"><i class="fas fa-chevron-right" style="margin-left:0.4rem;"></i> بازگشت</a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// جابه‌جایی بین تب‌ها
function activateTab(selector){
  document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const link = document.querySelector(`.tab-link[href='${selector}']`);
  const target = document.querySelector(selector);
  if(link && target){
    link.classList.add('active');
    target.classList.add('active');
  }
}

document.querySelectorAll('.tab-link').forEach(link => {
  link.addEventListener('click', function(e){
    e.preventDefault();
    activateTab(this.getAttribute('href'));
  });
});

// فعال‌سازی تب از آدرس
if(location.hash){
  activateTab(location.hash);
}
</script>
{% endblock %}
