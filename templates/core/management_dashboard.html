{% extends "core/base_management.html" %}
{% block title %}داشبورد مدیریت{% endblock %}
{% block management_content %}
<h2 class="page-title" style="display:flex;align-items:center;justify-content:space-between;">
  <span><i class="fas fa-chart-bar"></i> داشبورد مدیریت</span>
  <i class="fas fa-circle" title="وضعیت کیوسک" style="color:{% if device_online %}#4caf50{% else %}#f44336{% endif %};"></i>
</h2>
<form method="get" class="form-inline" style="margin-bottom:1rem;">
  <select name="group">
    <option value="">همه گروه‌ها</option>
    {% for g in groups %}
      <option value="{{ g.id }}" {% if g.id|stringformat:'s' == selected_group %}selected{% endif %}>{{ g.name }}</option>
    {% endfor %}
  </select>
  <select name="shift">
    <option value="">همه شیفت‌ها</option>
    {% for s in shifts %}
      <option value="{{ s.id }}" {% if s.id|stringformat:'s' == selected_shift %}selected{% endif %}>{{ s.name }}</option>
    {% endfor %}
  </select>
  <button class="btn" type="submit">فیلتر</button>
</form>

<div class="card fade-in">
  <h3 class="panel-title"><i class="fas fa-heartbeat"></i> نبض سازمان</h3>
  <canvas id="pulseChart" height="160"></canvas>
</div>

<div class="card fade-in">
  <h3 class="panel-title"><i class="fas fa-exclamation-circle"></i> مرکز اقدامات فوری</h3>
  <ul class="action-list">
    {% for req in pending_edit_requests %}
      <li>
        {{ req.user.get_full_name }} - {{ req.timestamp|date:"Y-m-d H:i" }} (ویرایش تردد)
        <form method="post" action="{% url 'edit_requests' %}" class="inline-form">
          {% csrf_token %}
          <input type="hidden" name="req_id" value="{{ req.id }}">
          <button name="action" value="approve" class="btn-small">تأیید</button>
          <button name="action" value="reject" class="btn-small btn-danger">رد</button>
        </form>
      </li>
    {% endfor %}
    {% for req in pending_leave_requests %}
      <li>
        {{ req.user.get_full_name }} - {{ req.start_date }} تا {{ req.end_date }} (درخواست مرخصی)
        <form method="post" action="{% url 'leave_requests' %}" class="inline-form">
          {% csrf_token %}
          <input type="hidden" name="req_id" value="{{ req.id }}">
          <button name="action" value="approve" class="btn-small">تأیید</button>
          <button name="action" value="reject" class="btn-small btn-danger">رد</button>
        </form>
      </li>
    {% endfor %}
    {% if not pending_edit_requests and not pending_leave_requests %}
      <li>درخواستی برای اقدام فوری وجود ندارد.</li>
    {% endif %}
  </ul>
</div>

<div class="card fade-in">
  <h3 class="panel-title"><i class="fas fa-user-clock"></i> رادار عملکرد</h3>
  <div class="performance-grid">
    <div>
      <h4>بیشترین تأخیر</h4>
      <ul>
        {% for item in tardy_top %}
          <li>{{ item.user.get_full_name }} - {{ item.tardy }} روز</li>
        {% empty %}
          <li>موردی نیست</li>
        {% endfor %}
      </ul>
    </div>
    <div>
      <h4>منظم‌ترین‌ها</h4>
      <ul>
        {% for item in punctual_top %}
          <li>{{ item.user.get_full_name }} - {{ item.on_time }} روز</li>
        {% empty %}
          <li>موردی نیست</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const pulseData = {
  labels: ['حاضر','غایب','مرخصی'],
  datasets: [{
    data: {{ pulse_data_json|safe }},
    backgroundColor: ['#4caf50','#f44336','#ff9800']
  }]
};
new Chart(document.getElementById('pulseChart'), {
  type: 'doughnut',
  data: pulseData,
  options: {plugins:{legend:{position:'bottom'}}, responsive:true}
});
</script>
{% endblock %}
