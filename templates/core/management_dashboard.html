{% extends "core/base_management.html" %}
{% block title %}داشبورد مدیریت{% endblock %}
{% block management_content %}
<h2 class="page-title">
  <i class="fas fa-chart-bar"></i> داشبورد مدیریت
  <span id="kiosk-status" class="kiosk-status {% if device_online %}online{% else %}offline{% endif %}" title="وضعیت اتصال">
    <i class="fas fa-desktop"></i>
  </span>
</h2>
<form method="get" class="form-inline" style="margin-bottom:1rem;">
  <select name="group">
    <option value="">همه گروه‌ها</option>
    {% for g in groups %}
      <option value="{{ g.id }}" {% if g.id|stringformat:'s' == selected_group %}selected{% endif %}>{{ g.name }}</option>
    {% endfor %}
  </select>
  <select name="shift">
    <option value="">همه شیفت‌ها</option>
    {% for s in shifts %}
      <option value="{{ s.id }}" {% if s.id|stringformat:'s' == selected_shift %}selected{% endif %}>{{ s.name }}</option>
    {% endfor %}
  </select>
  <button class="btn" type="submit">فیلتر</button>
</form>

<div class="card fade-in">
  <h3 class="panel-title"><i class="fas fa-bolt"></i> مرکز اقدامات فوری</h3>
  {% if pending_edit_requests or pending_leave_requests %}
  <table class="management-table">
    <thead>
      <tr>
        <th>کاربر</th>
        <th>تاریخ/بازه</th>
        <th>نوع</th>
        <th>اقدام</th>
      </tr>
    </thead>
    <tbody>
      {% for req in pending_edit_requests %}
      <tr>
        <td>{{ req.user.get_full_name }}</td>
        <td>{{ req.timestamp|date:"Y-m-d H:i" }}</td>
        <td>ویرایش تردد</td>
        <td>
          <form method="post" action="{% url 'edit_requests' %}">
            {% csrf_token %}
            <input type="hidden" name="req_id" value="{{ req.id }}">
            <button name="action" value="approve" class="btn">تأیید</button>
            <button name="action" value="reject" class="btn btn-danger">رد</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      {% for req in pending_leave_requests %}
      <tr>
        <td>{{ req.user.get_full_name }}</td>
        <td>{{ req.start_date }}{% if req.end_date != req.start_date %} تا {{ req.end_date }}{% endif %}</td>
        <td>درخواست مرخصی</td>
        <td>
          <form method="post" action="{% url 'leave_requests' %}">
            {% csrf_token %}
            <input type="hidden" name="req_id" value="{{ req.id }}">
            <button name="action" value="approve" class="btn">تأیید</button>
            <button name="action" value="reject" class="btn btn-danger">رد</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>درخواستی برای بررسی وجود ندارد.</p>
  {% endif %}
</div>

<div class="card fade-in">
  <h3 class="panel-title"><i class="fas fa-users"></i> رادار عملکرد</h3>
  <div class="performance-radar">
    <div class="radar-block">
      <h4>بیشترین تأخیر</h4>
      <ul>
        {% for item in top_tardy %}
          <li>{{ item.user.get_full_name }} - {{ item.tardy }} روز</li>
        {% empty %}
          <li>موردی نیست</li>
        {% endfor %}
      </ul>
    </div>
    <div class="radar-block">
      <h4>منظم‌ترین‌ها</h4>
      <ul>
        {% for item in top_punctual %}
          <li>{{ item.user.get_full_name }} - {{ item.tardy }} روز تأخیر</li>
        {% empty %}
          <li>موردی نیست</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<div class="card dashboard-panel fade-in">
  <h3 class="panel-title"><i class="fas fa-chart-pie"></i> نبض سازمان</h3>
  <canvas id="orgPulseChart" height="150"></canvas>
</div>

<div id="status-details" class="card fade-in" style="display:none;">
  <div id="present-list">
    <h4>حاضرین</h4>
    <ul>
      {% for u in present_users %}
        <li>{{ u.get_full_name }} - {{ u.personnel_code }}</li>
      {% empty %}
        <li>موردی ثبت نشده است</li>
      {% endfor %}
    </ul>
  </div>
  <div id="absent-list" style="display:none;">
    <h4>غایبین</h4>
    <ul>
      {% for u in absent_users %}
        <li>{{ u.get_full_name }} - {{ u.personnel_code }}</li>
      {% empty %}
        <li>همه حاضرند</li>
      {% endfor %}
    </ul>
  </div>
  <div id="leave-list" style="display:none;">
    <h4>مرخصی</h4>
    <ul>
      {% for u in leave_users %}
        <li>{{ u.get_full_name }} - {{ u.personnel_code }}</li>
      {% empty %}
        <li>موردی نیست</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('orgPulseChart');
const orgChart = new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['حاضر', 'غایب', 'مرخصی'],
    datasets: [{
      data: [{{ present_count }}, {{ absent_count }}, {{ leave_count }}],
      backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
    }]
  },
  options: {responsive: true, plugins: {legend: {position: 'bottom'}}}
});

ctx.onclick = function(evt){
  const points = orgChart.getElementsAtEventForMode(evt, 'nearest', {intersect: true}, true);
  if(points.length){
    const index = points[0].index;
    const lists = ['present', 'absent', 'leave'];
    document.getElementById('status-details').style.display = 'block';
    lists.forEach((name,i)=>{
      document.getElementById(name+'-list').style.display = i === index ? 'block':'none';
    });
  }
};

{% if not device_online %}
const statusEl = document.getElementById('kiosk-status');
setInterval(()=>statusEl.classList.toggle('blink'), 500);
{% endif %}
</script>
{% endblock %}

