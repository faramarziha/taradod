{% extends "core/base_management.html" %}
{% block title %}داشبورد مدیریت{% endblock %}
{% block management_content %}
<h2 class="page-title">
  <i class="fas fa-chart-bar"></i> داشبورد مدیریت
  <span class="device-status">
    <i class="fas fa-hdd {% if device_online %}online{% else %}offline{% endif %}"></i>
  </span>
</h2>
<form method="get" class="form-inline" style="margin-bottom:1rem;">
  <select name="group">
    <option value="">همه گروه‌ها</option>
    {% for g in groups %}
      <option value="{{ g.id }}" {% if g.id|stringformat:'s' == selected_group %}selected{% endif %}>{{ g.name }}</option>
    {% endfor %}
  </select>
  <select name="shift">
    <option value="">همه شیفت‌ها</option>
    {% for s in shifts %}
      <option value="{{ s.id }}" {% if s.id|stringformat:'s' == selected_shift %}selected{% endif %}>{{ s.name }}</option>
    {% endfor %}
  </select>
  <button class="btn" type="submit">فیلتر</button>
</form>

<div class="card fade-in">
  <h3 class="panel-title"><i class="fas fa-bolt"></i> مرکز اقدامات فوری</h3>
  <table class="management-table">
    <thead>
      <tr><th>کاربر</th><th>تاریخ</th><th>نوع</th><th>اقدام</th></tr>
    </thead>
    <tbody>
      {% for item in action_items %}
      <tr>
        <td>{{ item.obj.user.get_full_name }}</td>
        <td>{% if item.type == 'leave' %}{{ item.obj.start_date }}{% else %}{{ item.obj.timestamp|date:'Y-m-d' }}{% endif %}</td>
        <td>{% if item.type == 'leave' %}مرخصی{% else %}ویرایش تردد{% endif %}</td>
        <td>
          {% if item.type == 'leave' %}
          {% url 'leave_requests' as action_url %}
          {% else %}
          {% url 'edit_requests' as action_url %}
          {% endif %}
          <form method="post" action="{{ action_url }}" class="inline-form">
            {% csrf_token %}
            <input type="hidden" name="req_id" value="{{ item.obj.id }}">
            <button class="btn" name="action" value="approve">تأیید</button>
            <button class="btn btn-secondary" name="action" value="reject">رد</button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="4">درخواستی وجود ندارد.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card fade-in">
  <h3 class="panel-title"><i class="fas fa-tachometer-alt"></i> رادار عملکرد</h3>
  <div class="performance-radar">
    <div class="radar-column">
      <h4>بیشترین تأخیر</h4>
      <ul>
        {% for item in tardy_leaderboard %}
          <li>{{ item.user.get_full_name }} - {{ item.count }} روز</li>
        {% empty %}
          <li>موردی نیست</li>
        {% endfor %}
      </ul>
    </div>
    <div class="radar-column">
      <h4>منظم‌ترین‌ها</h4>
      <ul>
        {% for item in punctual_leaderboard %}
          <li>{{ item.user.get_full_name }} - {{ item.count }} روز</li>
        {% empty %}
          <li>موردی نیست</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<div class="card fade-in">
  <h3 class="panel-title"><i class="fas fa-chart-pie"></i> نبض سازمان</h3>
  <canvas id="orgPulseChart" height="160"></canvas>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const orgData = {
  labels: ['حاضر', 'غایب', 'مرخصی'],
  datasets: [{
    data: [{{ present_count }}, {{ absent_count }}, {{ leave_count }}],
    backgroundColor: ['#4caf50', '#f44336', '#ffc107']
  }]
};
const nameLists = [{{ present_names_json|safe }}, {{ absent_names_json|safe }}, {{ leave_names_json|safe }}];
const orgChart = new Chart(document.getElementById('orgPulseChart'), {
  type: 'doughnut',
  data: orgData,
  options: {
    onClick: (evt, elements) => {
      if (!elements.length) return;
      const idx = elements[0].index;
      const names = nameLists[idx];
      alert(names.length ? names.join('\n') : 'موردی نیست');
    }
  }
});
</script>
{% endblock %}
